name: Auto Register Kiro Accounts (Parallel)

on:
  #schedule:
    # Run every 6 hours (adjust as needed)
    #- cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      parallel_jobs:
        description: 'Number of parallel registration jobs'
        required: false
        default: '5'
        type: string

jobs:
  # Generate matrix dynamically based on input
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          JOBS=${{ github.event.inputs.parallel_jobs || '5' }}
          MATRIX=$(seq 1 $JOBS | jq -R . | jq -s -c .)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Will run $JOBS parallel jobs"

  register:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      # Allow jobs to run in parallel without waiting for each other
      fail-fast: false
      max-parallel: 10  # GitHub allows up to 20 concurrent jobs for free tier
      matrix:
        job_id: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          pip install --no-cache-dir -r requirements.txt

      - name: Install Playwright and system dependencies
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Install kiro-cli
        run: |
          echo "Installing kiro-cli using official installer..."
          curl -fsSL https://cli.kiro.dev/install | bash

          # Add to PATH for current session
          export PATH="$HOME/.local/bin:$PATH"

          # Add to PATH for subsequent steps
          echo "$HOME/.local/bin" >> $GITHUB_PATH

          # Verify installation
          kiro-cli --version && echo "✅ kiro-cli installed successfully" || echo "⚠️ kiro-cli installation may have issues"

      - name: Create config.json
        run: |
          cat > config.json << 'EOF'
          {
            "imap": {
              "host": "${{ secrets.IMAP_HOST }}",
              "port": ${{ secrets.IMAP_PORT }},
              "username": "${{ secrets.IMAP_USERNAME }}",
              "password": "${{ secrets.IMAP_PASSWORD }}",
              "use_ssl": false,
              "starttls": true,
              "verify_cert": false
            },
            "email_domain": "${{ secrets.EMAIL_DOMAIN }}",
            "backend_url": "${{ secrets.BACKEND_URL }}",
            "admin_password": "${{ secrets.ADMIN_PASSWORD }}"
          }
          EOF

      - name: Run registration (Job ${{ matrix.job_id }})
        env:
          DISPLAY: ':99'
          PYTHONUNBUFFERED: '1'
        run: |
          echo "Starting registration job ${{ matrix.job_id }}"
          # Each job registers 6 accounts sequentially
          python -u register.py --headless --count 6

      - name: Upload registration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: registration-logs-job-${{ matrix.job_id }}-${{ github.run_number }}
          path: |
            identity_account_*.json
            error_*.png
          retention-days: 7

      - name: Report status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "✅ Job ${{ matrix.job_id }} completed successfully"
          else
            echo "❌ Job ${{ matrix.job_id }} failed"
          fi

  summary:
    needs: register
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Registration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Total parallel jobs: ${{ github.event.inputs.parallel_jobs || '5' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Run number: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check individual job logs for detailed results." >> $GITHUB_STEP_SUMMARY
