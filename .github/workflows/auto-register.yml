name: Auto Register Kiro Accounts (Sequential)

on:
  workflow_dispatch:
    inputs:
      accounts_per_job:
        description: 'Number of accounts to register per job'
        required: false
        default: '6'
        type: string
      total_jobs:
        description: 'Total number of sequential jobs to run'
        required: false
        default: '5'
        type: string

jobs:
  register-sequence:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      # ä¸²è¡Œæ‰§è¡Œï¼Œä¸€æ¬¡åªè¿è¡Œä¸€ä¸ª job
      max-parallel: 1
      matrix:
        # é™æ€å®šä¹‰ job åºåˆ—ï¼Œæ”¯æŒæœ€å¤š 20 ä¸ª job
        job_id: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]

    steps:
      - name: Check if job should run
        id: should_run
        run: |
          TOTAL_JOBS=${{ github.event.inputs.total_jobs || '5' }}
          if [ ${{ matrix.job_id }} -lt $TOTAL_JOBS ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "âœ… Job ${{ matrix.job_id }} will run (total: $TOTAL_JOBS)"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Job ${{ matrix.job_id }} skipped (total: $TOTAL_JOBS)"
          fi

      - name: Checkout repository
        if: steps.should_run.outputs.should_run == 'true'
        uses: actions/checkout@v4

      - name: Set up Python
        if: steps.should_run.outputs.should_run == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            curl \
            unzip \
            gnupg \
            ca-certificates \
            fonts-liberation \
            fonts-noto-cjk \
            jq \
            docker.io

      - name: Install Python dependencies
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          pip install --no-cache-dir -r requirements.txt

      - name: Install Playwright browsers
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: Clean up any existing WARP containers
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          # åœæ­¢å¹¶åˆ é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®¹å™¨
          docker stop warproxy-${{ matrix.job_id }} || true
          docker rm warproxy-${{ matrix.job_id }} || true

      - name: Start fresh Cloudflare WARP Proxy
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "ðŸš€ Starting fresh Cloudflare WARP proxy for Job ${{ matrix.job_id }}..."
          
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ghcr.io/kingcc/warproxy:latest
          
          # å¯åŠ¨æ–°çš„ WARP ä»£ç†å®¹å™¨
          docker run -d --name warproxy-${{ matrix.job_id }} -p 1080:1080 ghcr.io/kingcc/warproxy:latest

          echo "â³ Waiting for WARP to initialize (35s)..."
          sleep 35

          # éªŒè¯ä»£ç†æ˜¯å¦å·¥ä½œ
          echo "ðŸ” Testing proxy connection..."
          for i in {1..10}; do
            if curl --socks5 127.0.0.1:1080 https://cloudflare.com/cdn-cgi/trace --connect-timeout 30 --max-time 45 --silent 2>/dev/null; then
              echo "âœ… WARP proxy is working (attempt $i)"
              break
            else
              echo "âš ï¸ Proxy not ready yet, waiting 5s more... (attempt $i)"
              sleep 5
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ WARP proxy failed to start after 10 attempts"
              exit 1
            fi
          done

          # èŽ·å–å½“å‰ WARP IP
          echo "ðŸŒ Getting current WARP IP address..."
          IP_INFO=$(curl --socks5 127.0.0.1:1080 https://ipinfo.io/json --connect-timeout 30 2>/dev/null || echo "{}")
          echo "Current Proxy IP Info:"
          echo "$IP_INFO" | jq '. | {ip: .ip, city: .city, region: .region, country: .country, org: .org}' || echo "Could not parse IP info"

      - name: Install kiro-cli
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          echo "ðŸ“¦ Installing kiro-cli using official installer..."
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p ~/.local/bin
          
          # ä¸‹è½½å¹¶å®‰è£…
          curl -fsSL https://cli.kiro.dev/install | bash

          # æ·»åŠ åˆ° PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿è·¯å¾„ç”Ÿæ•ˆ
          sleep 2
          
          # éªŒè¯å®‰è£…
          if ~/.local/bin/kiro-cli --version 2>/dev/null; then
            echo "âœ… kiro-cli installed successfully"
          else
            # å°è¯•ç›´æŽ¥è¿è¡Œ
            echo "Trying alternative installation check..."
            export PATH="$HOME/.local/bin:$PATH"
            kiro-cli --version && echo "âœ… kiro-cli verified" || echo "âš ï¸ kiro-cli may have issues"
          fi

      - name: Create config.json
        if: steps.should_run.outputs.should_run == 'true'
        run: |
          cat > config.json << 'EOF'
          {
            "imap": {
              "host": "${{ secrets.IMAP_HOST }}",
              "port": ${{ secrets.IMAP_PORT }},
              "username": "${{ secrets.IMAP_USERNAME }}",
              "password": "${{ secrets.IMAP_PASSWORD }}",
              "use_ssl": false,
              "starttls": true,
              "verify_cert": false
            },
            "email_domain": "${{ secrets.EMAIL_DOMAIN }}",
            "backend_url": "${{ secrets.BACKEND_URL }}",
            "admin_password": "${{ secrets.ADMIN_PASSWORD }}",
            "proxy": {
              "enabled": true,
              "server": "socks5://127.0.0.1:1080",
              "username": "",
              "password": ""
            }
          }
          EOF
          
          echo "ðŸ“ Config.json created for Job ${{ matrix.job_id }}"

      - name: Run registration (Job ${{ matrix.job_id }})
        if: steps.should_run.outputs.should_run == 'true'
        env:
          DISPLAY: ':99'
          PYTHONUNBUFFERED: '1'
          # è®¾ç½®ä»£ç†çŽ¯å¢ƒå˜é‡ï¼ˆå¤§å†™ï¼‰
          HTTP_PROXY: 'socks5://127.0.0.1:1080'
          HTTPS_PROXY: 'socks5://127.0.0.1:1080'
        run: |
          echo "========================================"
          echo "ðŸš€ Starting registration Job ${{ matrix.job_id }}"
          echo "========================================"
          
          # æ˜¾ç¤ºå½“å‰çŽ¯å¢ƒä¿¡æ¯
          echo "ðŸŒ Proxy settings:"
          echo "HTTP_PROXY: $HTTP_PROXY"
          echo "HTTPS_PROXY: $HTTPS_PROXY"
          
          # éªŒè¯ä»£ç†è¿žæŽ¥
          echo "ðŸ” Verifying proxy connectivity..."
          curl --socks5 127.0.0.1:1080 https://httpbin.org/ip --connect-timeout 30 && echo "âœ… Proxy verified" || echo "âš ï¸ Proxy verification failed"
          
          # è¿è¡Œæ³¨å†Œè„šæœ¬
          echo "ðŸ“ Registering ${{ github.event.inputs.accounts_per_job || '6' }} accounts..."
          python -u register.py --headless --count ${{ github.event.inputs.accounts_per_job || '6' }}
          
          echo "âœ… Job ${{ matrix.job_id }} registration completed"

      - name: Clean up WARP container for this job
        if: always() && steps.should_run.outputs.should_run == 'true'
        run: |
          echo "ðŸ§¹ Cleaning up WARP container for Job ${{ matrix.job_id }}..."
          docker stop warproxy-${{ matrix.job_id }} || true
          docker rm warproxy-${{ matrix.job_id }} || true
          echo "âœ… WARP container cleaned up"

      - name: Upload registration logs
        if: always() && steps.should_run.outputs.should_run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: registration-logs-job-${{ matrix.job_id }}-${{ github.run_number }}
          path: |
            identity_account_*.json
            error_*.png
            *.log
          retention-days: 7

      - name: Job completion delay
        if: success() && steps.should_run.outputs.should_run == 'true'
        run: |
          echo "â³ Waiting 10 seconds before next job..."
          sleep 10

  summary:
    needs: register-sequence
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Registration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Total sequential jobs:** ${{ github.event.inputs.total_jobs || '5' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Accounts per job:** ${{ github.event.inputs.accounts_per_job || '6' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Potential total accounts:** $(( (${{ github.event.inputs.total_jobs || '5' }}) * (${{ github.event.inputs.accounts_per_job || '6' }}) ))" >> $GITHUB_STEP_SUMMARY
          echo "- **Run number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Status:" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow status:** ${{ needs.register-sequence.result || 'unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ Check artifact logs for detailed registration results from each job." >> $GITHUB_STEP_SUMMARY
